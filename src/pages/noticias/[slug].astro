---
import Layout from '../../layouts/Layout.astro';
import { client } from '../../lib/sanity';
import { NOTICIA_DETALLE_QUERY, NOTICIAS_SLUGS_QUERY } from '../../lib/sanity.queries';
import type { Noticia, SlugParam } from '../../types/sanity.types';
import { urlFor } from '../../utils/sanity.utils';
import { PortableText } from 'astro-portabletext';

// Renderizado estático en build time
export const prerender = true;

// 1. Definir rutas estáticas para SSG
export async function getStaticPaths() {
  const slugs = await client.fetch<SlugParam[]>(NOTICIAS_SLUGS_QUERY);
  
  return slugs.map((item) => ({
    params: { slug: item.slug },
  }));
}

// 2. Obtener datos de la noticia específica
const { slug } = Astro.params;

const noticia = await client.fetch<Noticia | null>(
  NOTICIA_DETALLE_QUERY,
  { slug }
);

if (!noticia) {
  return Astro.redirect('/404');
}

// Formatear fecha
const fechaFormateada = new Date(noticia.fechaPublicacion).toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout title={noticia.titulo}>
  <main class="min-h-screen bg-gray-50 py-8 md:py-12">
    <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- Header -->
      <header class="mb-8">
        <a 
          href="/noticias" 
          class="inline-block text-gray-600 hover:text-blue-600 transition-colors mb-6 text-[15px]"
        >
          ← Volver a Noticias
        </a>
        
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold leading-tight mb-4 text-gray-900">
          {noticia.titulo}
        </h1>
        
        <div class="text-gray-600">
          <time datetime={noticia.fechaPublicacion}>
            {fechaFormateada}
          </time>
        </div>
      </header>

      <!-- Imagen de Portada -->
      {noticia.portada && (
        <figure class="my-8 md:my-12 rounded-xl overflow-hidden shadow-lg">
          <img
            src={urlFor(noticia.portada).width(1200).height(675).url()}
            srcset={`
              ${urlFor(noticia.portada).width(600).height(338).url()} 600w,
              ${urlFor(noticia.portada).width(1200).height(675).url()} 1200w,
              ${urlFor(noticia.portada).width(1800).height(1013).url()} 1800w
            `}
            sizes="(max-width: 1200px) 100vw, 1200px"
            alt={noticia.portada.alt || noticia.titulo}
            class="w-full h-auto"
          />
        </figure>
      )}

      <!-- Contenido (Portable Text) -->
      <div class="prose prose-lg prose-gray max-w-none
                  prose-headings:font-bold prose-headings:text-gray-900
                  prose-h2:text-3xl prose-h2:mt-10 prose-h2:mb-4
                  prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-3
                  prose-p:text-gray-700 prose-p:leading-relaxed prose-p:my-5
                  prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline
                  prose-strong:text-gray-900 prose-strong:font-bold
                  prose-ul:my-5 prose-ol:my-5
                  prose-li:my-2
                  prose-blockquote:border-l-4 prose-blockquote:border-gray-300 
                  prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-gray-600
                  prose-img:rounded-lg prose-img:shadow-md">
        <PortableText 
          value={noticia.contenido}
          components={{
            type: {
              image: ({ value }) => {
                const imageUrl = urlFor(value).width(800).url();
                return `
                  <figure class="my-8">
                    <img 
                      src="${imageUrl}"
                      alt="${value.alt || ''}"
                      loading="lazy"
                      class="rounded-lg"
                    />
                  </figure>
                `;
              },
            },
            marks: {
              link: ({ children, value }) => {
                const rel = value.href.startsWith('http') 
                  ? 'noopener noreferrer' 
                  : undefined;
                const target = value.href.startsWith('http') 
                  ? '_blank' 
                  : undefined;
                const relAttr = rel ? `rel="${rel}"` : '';
                const targetAttr = target ? `target="${target}"` : '';
                return `<a href="${value.href}" ${relAttr} ${targetAttr}>${children}</a>`;
              },
            },
          }}
        />
      </div>

      <!-- Footer con navegación -->
      <footer class="mt-12 pt-8 border-t border-gray-200 text-center">
        <a 
          href="/noticias" 
          class="inline-block px-8 py-3.5 bg-white text-blue-600 
                 border-2 border-blue-600 rounded-lg font-semibold 
                 hover:bg-blue-600 hover:text-white transition-all duration-200
                 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
          Ver Todas las Noticias
        </a>
      </footer>
    </article>
  </main>
</Layout>